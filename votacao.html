<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vota√ß√£o Karaok√™ - D√™ Sua Nota!</title>
    <!-- Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o de fontes e cores personalizadas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Outline&family=Changa+One:ital@0;1&display=swap');
        :root {
            /* Personalize o nome do seu evento e a URL da imagem de fundo */
            --logo-text: "Noite de Estrelas";
            --background-image: url('https://static.vecteezy.com/system/resources/previews/029/561/970/non_2x/music-karaoke-party-vivid-background-free-photo.jpg'); 
            --karaoke-pink: #ff1493; /* Deep Pink */
            --karaoke-blue: #00ffff; /* Aqua */
        }
        body {
            background-color: #0d131f; /* Azul escuro quase preto */
            background-image: var(--background-image);
            background-size: cover;
            background-attachment: fixed;
            color: white;
            font-family: 'Changa One', sans-serif;
            transition: all 0.3s ease;
        }
        /* Estilo para a caixa principal de vota√ß√£o */
        .vote-card {
            backdrop-filter: blur(10px) brightness(80%);
            background-color: rgba(13, 19, 31, 0.85); /* Fundo semi-transparente */
            border: 3px solid var(--karaoke-pink);
            box-shadow: 0 0 20px var(--karaoke-blue), 0 0 40px var(--karaoke-pink) inset;
        }
        /* Estilo para o t√≠tulo (fonte neon) */
        .karaoke-title {
            font-family: 'Bungee Outline', cursive;
            text-shadow: 0 0 5px var(--karaoke-blue), 0 0 10px var(--karaoke-pink);
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; text-shadow: 0 0 5px var(--karaoke-blue), 0 0 10px var(--karaoke-pink); }
            20%, 24%, 55% { opacity: 0.8; text-shadow: none; }
        }
        .score-button {
            transition: all 0.2s;
            background-color: var(--karaoke-pink);
            color: #0d131f;
            border: 1px solid var(--karaoke-blue);
        }
        .score-button:hover, .score-button.selected {
            background-color: var(--karaoke-blue);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 8px var(--karaoke-pink);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="vote-card max-w-4xl w-full p-8 rounded-2xl">
        <h1 class="karaoke-title text-4xl sm:text-5xl text-center mb-8">Vota√ß√£o Karaok√™ <span class="block text-2xl" id="event-name"></span></h1>
        
        <!-- √Årea de Vota√ß√£o Principal -->
        <div id="voting-area" class="transition-opacity duration-500">
            
            <!-- NOVO CAMPO: Nickname -->
            <div class="mb-6 bg-gray-700 p-4 rounded-lg">
                <label for="voter-nickname" class="block text-xl font-bold mb-2 text-yellow-300">Seu Nome ou Apelido (Obrigat√≥rio):</label>
                <input type="text" id="voter-nickname" placeholder="Digite seu nome/apelido" class="w-full p-3 rounded text-black bg-white border border-gray-400 focus:outline-none focus:border-karaoke-pink" maxlength="20">
            </div>

            <p class="text-center mb-6 text-xl text-yellow-300">Selecione um cantor e d√™ sua nota de 5 a 10!</p>
            
            <!-- Mensagens de Status -->
            <div class="text-center col-span-full mb-4">
                <p id="loading-message" class="text-xl">Carregando candidatos...</p>
                <p id="error-message" class="text-red-500 hidden">N√£o foi poss√≠vel carregar os candidatos. Tente novamente mais tarde.</p>
                <p id="status-message" class="text-red-400 hidden mt-2"></p>
            </div>
            
            <div id="candidates-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Lista de Candidatos ser√° injetada aqui -->
            </div>

            <!-- Bot√£o de Confirma√ß√£o -->
            <div class="text-center mt-8">
                <button id="submit-vote-btn" disabled class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    Votar
                </button>
            </div>
        </div>

        <!-- √Årea de Agradecimento (apenas fallback) -->
        <div id="thank-you-area" class="text-center hidden transition-opacity duration-500">
            <h2 class="text-3xl sm:text-4xl text-karaoke-blue mb-4">Obrigado pelo seu Voto! üéâ</h2>
            <p class="text-xl mb-6">Voc√™ ser√° redirecionado automaticamente para o ranking...</p>
            
             <button onclick="window.location.href = 'resultados.html';" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Ir para Resultados</button>
        </div>
    </div>

    <!-- Script do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, query, updateDoc, increment, runTransaction, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais MANDAT√ìRIAS do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configura√ß√£o de fallback usando os dados iniciais do usu√°rio
        const FALLBACK_CONFIG = {
            apiKey: "AIzaSyAuQ9XNsGVIp7Y0FRftnbNhDL9lGl8hNTI",
            authDomain: "karaoke-38a94.firebaseapp.com",
            projectId: "karaoke-38a94", 
            storageBucket: "karaoke-38a94.firebasestorage.app",
            messagingSenderId: "17039001114",
            appId: "1:17039001114:web:5a382081f045d4f84273a3"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FALLBACK_CONFIG;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Caminhos para as cole√ß√µes p√∫blicas
        const CANDIDATES_PATH = `/artifacts/${appId}/public/data/candidates`;
        const VOTES_PATH = `/artifacts/${appId}/public/data/votes`;

        let userId = null;
        let selectedCandidateId = null;
        let selectedScore = 0;
        let candidatesMap = {}; // Para armazenar candidatos por ID
        
        const nicknameInput = document.getElementById('voter-nickname');
        const statusMessage = document.getElementById('status-message');


        document.getElementById('event-name').textContent = document.documentElement.style.getPropertyValue('--logo-text');

        // --- Fun√ß√µes de Inicializa√ß√£o e Autentica√ß√£o ---
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Autenticado com sucesso. User ID:", userId);
                        loadCandidates();
                    } else {
                        console.error("Falha na autentica√ß√£o. Tentando novamente...");
                    }
                });
            } catch (error) {
                console.error("Erro durante a autentica√ß√£o:", error);
                document.getElementById('error-message').textContent = "Erro de autentica√ß√£o: " + error.message;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        // Exibe mensagens de status na UI
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'text-green-500', 'text-red-400');
            statusMessage.classList.add(isError ? 'text-red-400' : 'text-green-500');
            // Oculta a mensagem ap√≥s 5 segundos
            setTimeout(() => { statusMessage.classList.add('hidden'); }, 5000);
        }

        // --- Fun√ß√µes de Vota√ß√£o e UI ---

        // Carrega a lista de candidatos
        function loadCandidates() {
            const listContainer = document.getElementById('candidates-list');
            listContainer.innerHTML = '';
            
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            
            if (loadingMessage) loadingMessage.classList.remove('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');

            const candidatesQuery = query(collection(db, CANDIDATES_PATH));
            
            // onSnapshot para atualizar candidatos em tempo real e filtrar por isVotingEnabled
            onSnapshot(candidatesQuery, (snapshot) => {
                listContainer.innerHTML = '';
                candidatesMap = {}; 
                
                const enabledCandidates = snapshot.docs.filter(doc => doc.data().isVotingEnabled !== false); // Filtra por 'isVotingEnabled: true' ou n√£o definido
                
                if (enabledCandidates.length === 0) {
                    listContainer.innerHTML = `<p class="col-span-full text-xl text-yellow-500">Nenhum candidato com vota√ß√£o ativa. Verifique a p√°gina <a href="admin.html" class="text-karaoke-pink underline">Admin</a>.</p>`;
                } else {
                    enabledCandidates.forEach(doc => {
                        const candidate = doc.data();
                        candidatesMap[doc.id] = candidate;
                        listContainer.appendChild(createCandidateCard(doc.id, candidate.name));
                    });
                }
                if (loadingMessage) loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Erro ao carregar candidatos:", error);
                if (errorMessage) {
                    errorMessage.classList.remove('hidden');
                    errorMessage.textContent = "Erro ao carregar candidatos: " + error.message;
                }
                if (loadingMessage) loadingMessage.classList.add('hidden');
            });
        }

        // Cria o card de vota√ß√£o para um candidato
        function createCandidateCard(id, name) {
            const card = document.createElement('div');
            card.className = 'bg-gray-700 p-4 rounded-xl shadow-xl transition duration-300 hover:scale-[1.02]';
            
            // Notas de 5 a 10
            const scores = [5, 6, 7, 8, 9, 10]; 

            card.innerHTML = `
                <h3 class="text-2xl font-bold text-center mb-4 text-karaoke-blue">${name}</h3>
                <div class="score-selector flex justify-center flex-wrap gap-2" data-candidate-id="${id}">
                    ${scores.map(score => `
                        <button class="score-button w-10 h-10 rounded-full font-bold text-sm" data-score="${score}">${score}</button>
                    `).join('')}
                </div>
            `;
            
            card.querySelectorAll('.score-button').forEach(button => {
                button.addEventListener('click', (e) => handleScoreSelection(e, id));
            });
            return card;
        }

        // Lida com a sele√ß√£o da nota
        function handleScoreSelection(event, candidateId) {
            const clickedButton = event.currentTarget;
            const score = parseInt(clickedButton.getAttribute('data-score'));
            
            // Limpa sele√ß√µes de score para todos os cards
            document.querySelectorAll('.score-button').forEach(btn => btn.classList.remove('selected'));

            // Seleciona o novo bot√£o
            clickedButton.classList.add('selected');

            selectedCandidateId = candidateId;
            selectedScore = score;
            document.getElementById('submit-vote-btn').disabled = false;
        }

        // Envia o voto para o Firestore
        document.getElementById('submit-vote-btn').addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname) {
                showStatus("Por favor, insira seu nome ou apelido para votar.", true);
                return;
            }
            if (!selectedCandidateId || selectedScore < 5) {
                showStatus("Selecione um candidato e uma nota (5-10).", true);
                return;
            }

            const button = document.getElementById('submit-vote-btn');
            button.textContent = "Verificando...";
            button.disabled = true;

            try {
                // 1. VERIFICA√á√ÉO DE VOTO √öNICO POR CANDIDATO/NICKNAME
                const existingVoteQuery = query(
                    collection(db, VOTES_PATH),
                    where("candidateId", "==", selectedCandidateId),
                    where("voterNickname", "==", nickname)
                );
                
                const existingVotesSnapshot = await getDocs(existingVoteQuery);

                if (!existingVotesSnapshot.empty) {
                    showStatus("Voc√™ j√° votou neste candidato com este apelido.", true);
                    button.textContent = "Votar";
                    button.disabled = false;
                    return;
                }

                // 2. Salva o voto individual
                button.textContent = "Enviando...";
                await addDoc(collection(db, VOTES_PATH), {
                    candidateId: selectedCandidateId,
                    score: selectedScore,
                    voterNickname: nickname, // NOVO CAMPO
                    timestamp: new Date().toISOString(),
                    voterId: userId
                });
                
                // 3. Atualiza o resumo de pontos 
                await updateCandidateSummary(selectedCandidateId, selectedScore);

                // 4. REDIRECIONAMENTO AUTOM√ÅTICO
                showStatus("Voto enviado com sucesso! Redirecionando...", false);
                setTimeout(() => {
                    window.location.href = 'resultados.html';
                }, 1000);


            } catch (e) {
                console.error("Erro ao enviar voto: ", e);
                showStatus(`Erro ao votar. Verifique a conex√£o ou as regras do Firebase. Detalhe: ${e.message}`, true);
                button.textContent = "Votar";
                button.disabled = false;
            }
        });

        // Tenta atualizar o resumo do candidato usando Transaction para seguran√ßa de concorr√™ncia
        async function updateCandidateSummary(candidateId, score) {
            const candidateRef = doc(db, CANDIDATES_PATH, candidateId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const candidateDoc = await transaction.get(candidateRef);

                    if (!candidateDoc.exists()) {
                        throw "Candidato n√£o encontrado!";
                    }
                    
                    const newTotalScore = (candidateDoc.data().totalScore || 0) + score;
                    const newVoteCount = (candidateDoc.data().voteCount || 0) + 1;
                    
                    transaction.update(candidateRef, {
                        totalScore: newTotalScore,
                        voteCount: newVoteCount,
                    });
                });
                console.log("Resumo do candidato atualizado com sucesso.");
            } catch (e) {
                console.error("Erro na transa√ß√£o de atualiza√ß√£o do resumo:", e);
                await updateDoc(candidateRef, {
                    totalScore: increment(score),
                    voteCount: increment(1)
                });
            }
        }
        
        window.onload = initializeAuth;

    </script>
</body>
</html>
