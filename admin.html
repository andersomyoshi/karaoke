<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Candidatos</title>
    <!-- Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Configuração de fontes e cores personalizadas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Outline&family=Changa+One:ital@0;1&display=swap');
        :root {
            --background-image: url('https://placehold.co/1920x1080/1f0d1f/00ffff?text=Painel+Admin'); 
            --karaoke-pink: #ff1493; /* Deep Pink */
            --karaoke-blue: #00ffff; /* Aqua */
        }
        body {
            background-color: #1f0d1f; /* Roxo escuro */
            background-image: var(--background-image);
            background-size: cover;
            background-attachment: fixed;
            color: white;
            font-family: 'Changa One', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .admin-card {
            backdrop-filter: blur(10px) brightness(80%);
            background-color: rgba(31, 13, 31, 0.85);
            border: 3px solid var(--karaoke-blue);
            box-shadow: 0 0 15px var(--karaoke-pink), 0 0 30px var(--karaoke-blue) inset;
        }
        .admin-title {
            font-family: 'Bungee Outline', cursive;
            text-shadow: 0 0 10px var(--karaoke-pink), 0 0 20px var(--karaoke-blue);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Botões de Navegação -->
    <div class="absolute top-4 left-4 flex space-x-3">
        <a href="votacao.html" class="bg-gray-700 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 z-10">
            <i class="fas fa-vote-yea"></i> Votação
        </a>
        <a href="resultados.html" class="bg-gray-700 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 z-10">
            <i class="fas fa-trophy"></i> Resultados
        </a>
    </div>

    <!-- Painel de Administração -->
    <div class="admin-card w-full max-w-xl p-8 rounded-2xl">
        <h1 class="admin-title text-4xl sm:text-5xl text-center mb-8">PAINEL DE ADMINISTRAÇÃO</h1>

        <!-- Adicionar Novo Candidato -->
        <div class="mb-6">
            <h3 class="text-2xl font-semibold mb-3 text-yellow-400 border-b pb-2 border-gray-600">Adicionar Cantor</h3>
            <input type="text" id="new-candidate-name" placeholder="Nome do Novo Cantor" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-karaoke-pink mb-3">
            <button id="add-candidate-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300">
                <i class="fas fa-user-plus"></i> Adicionar Candidato
            </button>
        </div>

        <!-- Lista de Candidatos Atuais (com opção de exclusão) -->
        <div class="mb-8">
            <h3 class="text-2xl font-semibold mb-3 text-yellow-400 border-b pb-2 border-gray-600">Candidatos Atuais</h3>
            <ul id="admin-candidates-list" class="space-y-3 p-2 bg-gray-800 rounded-lg max-h-60 overflow-y-auto">
                <p class="text-center text-gray-400" id="loading-candidates">Carregando...</p>
            </ul>
        </div>
        
         <!-- Botão de Reset (Limpar Votos) -->
        <div class="mt-6 pt-4 border-t border-gray-700">
            <button id="reset-votes-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-300">
                <i class="fas fa-trash-alt"></i> Limpar TODOS os Votos
            </button>
        </div>
    </div>
    
    <!-- Modal de Confirmação (customizado) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full border-2 border-red-500">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirmação Necessária</h3>
            <p id="modal-message" class="mb-6">Tem certeza que deseja fazer isso?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Script do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, query, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais MANDATÓRIAS do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configuração de fallback usando os dados iniciais do usuário
        const FALLBACK_CONFIG = {
            apiKey: "AIzaSyAuQ9XNsGVIp7Y0FRftnbNhDL9lGl8hNTI",
            authDomain: "karaoke-38a94.firebaseapp.com",
            projectId: "karaoke-38a94", // ESTE CAMPO ESTAVA FALTANDO OU ERA NULO!
            storageBucket: "karaoke-38a94.firebasestorage.app",
            messagingSenderId: "17039001114",
            appId: "1:17039001114:web:5a382081f045d4f84273a3"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FALLBACK_CONFIG;
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Caminhos para as coleções públicas
        const CANDIDATES_PATH = `/artifacts/${appId}/public/data/candidates`;
        const VOTES_PATH = `/artifacts/${appId}/public/data/votes`;

        let userId = null;

        // --- Funções de Inicialização e Autenticação ---
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Admin autenticado. User ID:", userId);
                        // Inicia listeners após autenticação
                        listenForAdminCandidates();
                    } else {
                        console.error("Falha na autenticação Admin.");
                    }
                });
            } catch (error) {
                console.error("Erro durante a autenticação:", error);
            }
        }
        
        // --- Funções de Administração (Candidatos) ---

        // Adiciona um novo candidato
        document.getElementById('add-candidate-btn').addEventListener('click', async () => {
            console.log("Botão 'Adicionar Candidato' clicado."); // LOG: Confirma clique
            const input = document.getElementById('new-candidate-name');
            const name = input.value.trim();

            console.log("Nome do candidato a ser adicionado:", name); // LOG: Exibe o valor do campo

            if (name) {
                try {
                    await addDoc(collection(db, CANDIDATES_PATH), {
                        name: name,
                        totalScore: 0,
                        voteCount: 0,
                        createdAt: new Date().toISOString()
                    });
                    input.value = ''; // Limpa o campo
                    console.log(`Candidato "${name}" adicionado com sucesso.`);
                } catch (e) {
                    console.error("Erro ao adicionar candidato: ", e);
                    
                    // VERIFICAÇÃO DE PERMISSÃO MAIS DETALHADA
                    if (e.code && e.code === 'permission-denied') {
                        console.error("ERRO DE PERMISSÃO (403): Verifique as Regras de Segurança do Firestore. O usuário autenticado não tem permissão de 'write' na coleção 'candidates'.");
                        showConfirmationModal(`ERRO DE PERMISSÃO: Não foi possível adicionar o candidato. Por favor, verifique as Regras de Segurança do Firebase.`, () => {}, 'Erro');
                    } else {
                        showConfirmationModal(`Erro ao adicionar candidato. Detalhe: ${e.message}`, () => {}, 'Erro');
                    }
                }
            } else {
                console.error("Por favor, insira o nome do cantor. O campo está vazio.");
            }
        });

        // Escuta em tempo real a lista de candidatos para o painel admin
        function listenForAdminCandidates() {
            const listContainer = document.getElementById('admin-candidates-list');
            const loadingMessage = document.getElementById('loading-candidates');
            const candidatesQuery = query(collection(db, CANDIDATES_PATH));
            
            if (loadingMessage) loadingMessage.textContent = 'Carregando...';

            onSnapshot(candidatesQuery, (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum candidato cadastrado.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const candidate = doc.data();
                        listContainer.appendChild(createAdminCandidateItem(doc.id, candidate.name));
                    });
                }
            }, (error) => {
                console.error("Erro ao carregar lista admin:", error);
                
                let displayMessage = `Erro ao carregar lista: ${error.message}`;
                if (error.code && error.code === 'permission-denied') {
                    displayMessage = "ERRO: Permissão negada. Verifique suas Regras de Segurança do Firebase!";
                    console.error("ERRO DE PERMISSÃO (403): O usuário não tem permissão de 'read' na coleção 'candidates'.");
                }
                
                listContainer.innerHTML = `<p class="text-center text-red-400">${displayMessage}</p>`;
            });
        }

        // Cria o item da lista de administração
        function createAdminCandidateItem(id, name) {
            const item = document.createElement('li');
            item.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
            item.innerHTML = `
                <span>${name}</span>
                <button data-id="${id}" class="delete-candidate-btn text-red-400 hover:text-red-600 transition duration-150 p-1">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            item.querySelector('.delete-candidate-btn').addEventListener('click', handleDeleteCandidate);
            return item;
        }

        // Lida com a exclusão de um candidato
        function handleDeleteCandidate(event) {
            const candidateId = event.currentTarget.getAttribute('data-id');
            showConfirmationModal("Tem certeza que deseja DELETAR este candidato e todos os seus votos associados?", async () => {
                 try {
                    // 1. Deleta o documento do candidato (que contém o resumo)
                    await deleteDoc(doc(db, CANDIDATES_PATH, candidateId));
                    
                    // 2. Tenta deletar todos os votos individuais (opcional, mas bom para limpeza)
                    const votesQuery = query(collection(db, VOTES_PATH), where("candidateId", "==", candidateId));
                    const votesSnapshot = await getDocs(votesQuery);
                    
                    const batch = writeBatch(db);
                    votesSnapshot.forEach(voteDoc => {
                        batch.delete(voteDoc.ref);
                    });
                    await batch.commit();

                    console.log(`Candidato ${candidateId} e seus votos deletados.`);
                    showConfirmationModal(`Candidato e votos deletados com sucesso.`, () => {}, 'Sucesso');
                } catch (e) {
                    console.error("Erro ao deletar candidato/votos:", e);
                    showConfirmationModal(`Erro ao deletar. Verifique as regras do Firebase. Detalhe: ${e.message}`, () => {}, 'Erro');
                }
            });
        }
        
        // --- Funções de Reset (Limpar Votos) ---
        
        document.getElementById('reset-votes-btn').addEventListener('click', () => {
            showConfirmationModal("ATENÇÃO: Isso limpará TODOS os votos e resetará a contagem de todos os candidatos. Você confirma?", async () => {
                try {
                    // 1. Resetar os resumos dos candidatos (totalScore e voteCount)
                    const candidatesSnapshot = await getDocs(collection(db, CANDIDATES_PATH));
                    const candidateBatch = writeBatch(db);
                    candidatesSnapshot.forEach(candidateDoc => {
                         candidateBatch.update(candidateDoc.ref, { totalScore: 0, voteCount: 0 });
                    });
                    await candidateBatch.commit();
                    
                    // 2. Deletar todos os votos individuais
                    const votesSnapshot = await getDocs(collection(db, VOTES_PATH));
                    const votesBatch = writeBatch(db);
                    votesSnapshot.forEach(voteDoc => {
                        votesBatch.delete(voteDoc.ref);
                    });
                    await votesBatch.commit();

                    showConfirmationModal(`Todos os votos e contagens foram zerados com sucesso!`, () => {}, 'Sucesso');
                } catch (e) {
                    console.error("Erro ao resetar votos:", e);
                    showConfirmationModal(`Erro ao resetar. Verifique as regras do Firebase. Detalhe: ${e.message}`, () => {}, 'Erro');
                }
            });
        });

        // --- Modal de Confirmação Customizado (Duplicado para este arquivo) ---
        let actionToConfirm = null;
        let confirmMode = 'Confirm';
        const modal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        const modalTitle = modal.querySelector('h3');


        function showConfirmationModal(message, callback, mode = 'Confirm') {
            modalTitle.textContent = mode === 'Erro' ? 'Erro' : (mode === 'Sucesso' ? 'Sucesso' : 'Confirmação Necessária');
            modalMessage.textContent = message;
            actionToConfirm = callback;
            confirmMode = mode;
            
            if (mode === 'Confirm') {
                modalTitle.classList.remove('text-green-400', 'text-red-400');
                modalTitle.classList.add('text-red-400');
                confirmBtn.classList.remove('hidden');
                cancelBtn.textContent = "Cancelar";
            } else if (mode === 'Sucesso') {
                modalTitle.classList.remove('text-red-400');
                modalTitle.classList.add('text-green-400');
                confirmBtn.classList.add('hidden');
                cancelBtn.textContent = "Fechar";
            } else if (mode === 'Erro') {
                modalTitle.classList.remove('text-green-400');
                modalTitle.classList.add('text-red-400');
                confirmBtn.classList.add('hidden');
                cancelBtn.textContent = "Fechar";
            }
            
            modal.classList.remove('hidden');
        }

        confirmBtn.onclick = () => {
            if (actionToConfirm && confirmMode === 'Confirm') {
                actionToConfirm();
            }
            modal.classList.add('hidden');
            actionToConfirm = null;
        };

        cancelBtn.onclick = () => {
            modal.classList.add('hidden');
            actionToConfirm = null;
        };
        
        // Inicia o processo
        window.onload = initializeAuth;

    </script>
</body>
</html>