<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking - Karaokê</title>
    <!-- Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Configuração de fontes e cores personalizadas -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Outline&family=Changa+One:ital@0;1&display=swap');
        :root {
            --background-image: url('https://placehold.co/1920x1080/1f0d1f/00ffff?text=Ranking+Karaokê+Ao+Vivo'); 
            --karaoke-pink: #ff1493; /* Deep Pink */
            --karaoke-blue: #00ffff; /* Aqua */
        }
        body {
            background-color: #1f0d1f; /* Roxo escuro */
            background-image: var(--background-image);
            background-size: cover;
            background-attachment: fixed;
            color: white;
            font-family: 'Changa One', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .ranking-card {
            backdrop-filter: blur(10px) brightness(80%);
            background-color: rgba(31, 13, 31, 0.85);
            border: 3px solid var(--karaoke-blue);
            box-shadow: 0 0 15px var(--karaoke-pink), 0 0 30px var(--karaoke-blue) inset;
        }
        .ranking-title {
            font-family: 'Bungee Outline', cursive;
            text-shadow: 0 0 10px var(--karaoke-pink), 0 0 20px var(--karaoke-blue);
            color: white;
            animation: pulse 2s infinite alternate;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.02); opacity: 0.95; }
        }
        /* Estilos específicos para o 1º lugar */
        .winner {
            background: linear-gradient(45deg, var(--karaoke-pink), var(--karaoke-blue));
            color: #1f0d1f;
            transform: scale(1.05);
            font-size: 2.5rem; /* Maior nome */
            box-shadow: 0 0 25px gold;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- BOTÕES DE NAVEGAÇÃO REMOVIDOS CONFORME SOLICITADO -->

    <h1 class="ranking-title text-5xl sm:text-6xl text-center mb-8">CLASSIFICAÇÃO KARAOKÊ</h1>

    <!-- Coluna de Resultados (Ranking) -->
    <div class="ranking-card w-full max-w-4xl p-6 rounded-2xl flex flex-col min-h-[500px]">
        <h2 class="text-3xl font-bold mb-6 text-center text-yellow-300 border-b pb-3 border-gray-600">Ranking ao Vivo</h2>
        <div id="ranking-list" class="flex flex-col gap-4 flex-grow">
            <p class="text-center text-xl" id="ranking-loading">Carregando resultados...</p>
        </div>
    </div>


    <!-- Script do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais MANDATÓRIAS do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configuração de fallback usando os dados iniciais do usuário
        const FALLBACK_CONFIG = {
            apiKey: "AIzaSyAuQ9XNsGVIp7Y0FRftnbNhDL9lGl8hNTI",
            authDomain: "karaoke-38a94.firebaseapp.com",
            projectId: "karaoke-38a94", // ESTE CAMPO ESTAVA FALTANDO OU ERA NULO!
            storageBucket: "karaoke-38a94.firebasestorage.app",
            messagingSenderId: "17039001114",
            appId: "1:17039001114:web:5a382081f045d4f84273a3"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : FALLBACK_CONFIG;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Caminhos para as coleções públicas
        const CANDIDATES_PATH = `/artifacts/${appId}/public/data/candidates`;

        let userId = null;

        // --- Funções de Inicialização e Autenticação ---
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Visualizador autenticado. User ID:", userId);
                        // Inicia listeners após autenticação
                        listenForRanking();
                    } else {
                        console.error("Falha na autenticação Visualizador.");
                    }
                });
            } catch (error) {
                console.error("Erro durante a autenticação:", error);
            }
        }

        // --- Funções de Ranking (Classificação) ---
        
        // Escuta em tempo real os dados dos candidatos para criar o ranking
        function listenForRanking() {
            const rankingList = document.getElementById('ranking-list');
            const rankingLoading = document.getElementById('ranking-loading'); 
            const summaryQuery = query(collection(db, CANDIDATES_PATH));
            
            onSnapshot(summaryQuery, (snapshot) => {
                let results = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const avg = data.voteCount > 0 ? (data.totalScore / data.voteCount).toFixed(2) : '0.00';
                    results.push({ id: doc.id, name: data.name, avgScore: parseFloat(avg), voteCount: data.voteCount || 0 });
                });

                // Ordena por média de pontos (decrescente)
                results.sort((a, b) => b.avgScore - a.avgScore);

                rankingList.innerHTML = '';
                if (results.length === 0) {
                    rankingList.innerHTML = `<p class="text-center text-xl text-red-400">Nenhum candidato ou voto ainda.</p>`;
                } else {
                    results.forEach((r, index) => {
                        rankingList.appendChild(createRankingItem(r, index + 1));
                    });
                }
                
                if (rankingLoading) {
                    rankingLoading.style.display = 'none';
                }
                
            }, (error) => {
                console.error("Erro ao carregar ranking:", error);
                rankingList.innerHTML = `<p class="text-red-500 text-center">Erro ao carregar ranking: ${error.message}</p>`;
                
                if (rankingLoading) {
                    rankingLoading.style.display = 'none';
                }
            });
        }

        // Cria o elemento visual de um item do ranking
        function createRankingItem(candidate, rank) {
            const item = document.createElement('div');
            const isWinner = rank === 1 && candidate.voteCount > 0;
            
            item.className = `p-4 rounded-xl flex justify-between items-center transition-all duration-300 shadow-lg ${isWinner ? 'winner' : 'bg-gray-800 hover:bg-gray-700'}`;
            
            item.innerHTML = `
                <div class="flex items-center space-x-4">
                    <span class="text-3xl font-extrabold ${isWinner ? 'text-black' : 'text-karaoke-pink'}">${rank}º</span>
                    <span class="font-bold ${isWinner ? 'text-3xl text-black' : 'text-xl text-white'}">${candidate.name}</span>
                </div>
                <div class="text-right">
                    <span class="block text-2xl font-extrabold ${isWinner ? 'text-black' : 'text-karaoke-blue'}">${candidate.avgScore.toFixed(2)}</span>
                    <span class="${isWinner ? 'text-black' : 'text-gray-400'} text-sm">Média (${candidate.voteCount} votos)</span>
                </div>
            `;
            return item;
        }

        // Inicia o processo
        window.onload = initializeAuth;

    </script>
</body>
</html>